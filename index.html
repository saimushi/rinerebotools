<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="utf-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<meta name="description" content="血盟管理ツール"/>
		<meta name="robots" content="noindex"/>
		<title>L2R Tool</title>
		<!-- bootstrap -->
		<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"/>
		<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/css-spinning-spinners/1.1.1/load8.css"/>
		<link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
		<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css" />
		<!-- this app -->
		<style>
			html, body {
				height: 100%;
			}
			navigationbar .container {
				width: 100%;
			}
			.orverlay {
				display: none;
				position: absolute;
				height: 100%;
				width: 100%;
				z-index: 9999;
				background-color: rgba(0, 0, 0, 0.4);
			}
			div.row div.col-xs-4 {
				padding-right: 0;
			}
			div.row div.col-xs-8 {
				padding-left: 0;
			}
			div.row div div.container-fluid {
				padding: 0;
			}
			.btn-group {
				width: 100%;
			}
			.btn-group .form-control {
				padding-right: 20px;
			}
			.clearbtn {
				position: absolute;
				right: 5px;
				top: 0;
				bottom: 0;
				height: 14px;
				margin: auto;
				font-size: 14px;
				cursor: pointer;
				color: #ccc;
			}
			th, tr {
				font-size: 10px;
			}
			#loader {
				z-index: 99999;
			}
		</style>
	</head>

	<body>
		<div id="loader" class="orverlay loading"></div>
		<div id="popup" class="orverlay"></div>
		<app class="container">
			<navigationbar></navigationbar>
			<router class="row">
				<route path="/">
					<top/>
				</route>
				<route path="dashboard">
					<dashboard/>
				</route>
				<route path="login">
					<login/>
				</route>
				<route path="addclan">
					<addclan/>
				</route>
				<route path="adduser">
					<adduser/>
				</route>
				<route path="addschedule">
					<addschedule/>
				</route>
				<route path="modifyuser">
					<adduser/>
				</route>
				<route path="detailschedule">
					<detailschedule/>
				</route>
			</router>
		</app>

		<!-- Riot tags -->
		<section id="riot-tags">

			<script type="riot/tag">
				<navigationbar>
					<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
						<div class="container">
							<div class="navbar-header">
								<!-- sp用 -->
								<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
									<span class="sr-only">Toggle navigation</span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</button>
								<a class="navbar-brand" href="#">L2R Tool</a>
							</div>
							<div class="collapse navbar-collapse">
								<ul class="nav navbar-nav">
									<li><a href="#dashboard">血盟ページ</a></li>
									<li><a href="/">ログアウト</a></li>
									<li><a href="mailto:saimushi@gmail.com">お問い合わせ</a></li>
								</ul>
							</div>
						</div>
					</div>
				</navigationbar>
			</script>

			<script type="riot/tag">
				<top>
					this.on('mount', function() {
						// 認証
						auth();
					});
				</top>
			</script>

			<script type="riot/tag">
				<dashboard>
					<div  class="row">
						<div class="col-xs-4">
							<div class="container-fluid" style="padding: 10px;">
								<h2 style="margin-top: 10px;"><a href="{clanurl}">{clanname}</a></h2>
								<h4>血盟員数: {usercnt}</h4>
								<div  class="row" style="padding-left: 15px; padding-bottom: 10px;">
									<a class="btn btn-success" href="#addschedule">予定追加</a>
									<a class="btn btn-info" href="#adduser">血盟員追加</a>
								</div>
								<table class="table table-bordered table-hover table-striped">
									<thead>
										<tr class="info">
											<th>予定日</th>
											<th>予定内容</th>
											<th>参加人数</th>
										</tr>
									</thead>
									<tbody>
										<tr each="{schedule, index in schedules}" onclick="onclickSchedule(this, '{schedule.ID}');">
											<td>{schedule.date}</td>
											<td>{schedule.name}</td>
											<td>{schedule.incount}</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
						<div class="col-xs-8">
							<div class="container-fluid" style="padding-top: 50px;">
								<users data='{users}'/>
							</div>
						</div>

					</div>
					var clanname = '';
					var clanurl = 'javascript: void(0); return false;';
					var usercnt = 0;
					var users = [];
					var schedules = [];
					var cpSort = false;
					this.on('mount', function() {
						// 認証
						auth(false, function (clan) {
							if ('undefined' != typeof clan.name) {
								this.clanname = clan.name;
								this.clanurl = clan.url;
								getUsers(clan.ID, function(users) {
									this.users = users;
									this.usercnt = users.length;
									riot.update();
									getSchedules(clan.ID, function(schedules) {
										this.schedules = schedules;
										riot.update();
									});
								});
							}
						});
					});
				</dashboard>
			</script>

			<script type="riot/tag">
				<login>
					<div style="padding: 10px;">
						<h2>血盟ログイン</h2>
						<form id="loginform">
							<div class="form-group">
								<div class="btn-group">
									<input type="text" name="clanID" class="form-control" placeholder="血盟ID"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<botton class="btn btn-success" onclick="onclickLogin(this)">ログイン</botton>
							<botton class="btn btn-info" onclick="onclickAddClan(this)">血盟登録</botton>
						</form>
					</div>
					this.on('mount', function() {
						auth();
					});
				</login>
			</script>

			<script type="riot/tag">
				<addclan>
					<div style="padding: 10px;">
						<form id="registerClanform">
							<div class="form-group">
								<div class="btn-group">
									<input type="text" name="clan" class="form-control" placeholder="血盟名"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<div class="form-group">
								<div class="btn-group">
									<input type="text" name="url" class="form-control" placeholder="血盟コミュニティURL"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<botton class="btn btn-success" onclick="onclickRegisterClan(this)">登録</botton>
						</form>
					</div>
				</addclan>
			</script>

			<script type="riot/tag">
				<adduser>
					<div style="padding: 10px;">
						<h2>血盟員追加</h2>
						<form id="registerform">
							<div class="form-group">
								<div class="btn-group">
									<input type="text" name="username" value="{user.name}" class="form-control" placeholder="キャラクター名"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<div class="form-group">
								<select class="form-control" name="userjob">
									<option>職業</option>
									<optgroup label="ヒューマン">
										<option if={user.job=='パラディン'} value="パラディン" selected="selected">パラディン</option>
										<option if={user.job=='ウォーロード'} value="ウォーロード" selected="selected">ウォーロード</option>
										<option if={user.job=='トレジャーハンター'} value="トレジャーハンター" selected="selected">トレジャーハンター</option>
										<option if={user.job=='ホークアイ'} value="ホークアイ" selected="selected">ホークアイ</option>
										<option if={user.job=='ソーサラー'} value="ソーサラー" selected="selected">ソーサラー</option>
										<option if={user.job=='ビショップ'} value="ビショップ" selected="selected">ビショップ</option>
										<option if={user.job!='パラディン'} value="パラディン">パラディン</option>
										<option if={user.job!='ウォーロード'} value="ウォーロード">ウォーロード</option>
										<option if={user.job!='トレジャーハンター'} value="トレジャーハンター">トレジャーハンター</option>
										<option if={user.job!='ホークアイ'} value="ホークアイ">ホークアイ</option>
										<option if={user.job!='ソーサラー'} value="ソーサラー">ソーサラー</option>
										<option if={user.job!='ビショップ'} value="ビショップ">ビショップ</option>
									</optgroup>
									<optgroup label="エルフ">
										<option if={user.job=='テンプルナイト'} value="テンプルナイト" selected="selected">テンプルナイト	</option>
										<option if={user.job=='ソードシンガー'} value="ソードシンガー" selected="selected">ソードシンガー	</option>
										<option if={user.job=='プレインズウォーカー'} value="プレインズウォーカー" selected="selected">プレインズウォーカー</option>
										<option if={user.job=='シルバーレンジャー'} value="シルバーレンジャー" selected="selected">シルバーレンジャー</option>
										<option if={user.job=='スペルシンガー'} value="スペルシンガー" selected="selected">スペルシンガー</option>
										<option if={user.job=='エルダー'} value="エルダー" selected="selected">エルダー</option>
										<option if={user.job!='テンプルナイト'} value="テンプルナイト">テンプルナイト	</option>
										<option if={user.job!='ソードシンガー'} value="ソードシンガー">ソードシンガー	</option>
										<option if={user.job!='プレインズウォーカー'} value="プレインズウォーカー">プレインズウォーカー</option>
										<option if={user.job!='シルバーレンジャー'} value="シルバーレンジャー">シルバーレンジャー</option>
										<option if={user.job!='スペルシンガー'} value="スペルシンガー">スペルシンガー</option>
										<option if={user.job!='エルダー'} value="エルダー">エルダー</option>
									</optgroup>
									<optgroup label="ダークエルフ">
										<option if={user.job=='シリエンナイト'} value="シリエンナイト" selected="selected">シリエンナイト</option>
										<option if={user.job=='ブレードダンサー'} value="ブレードダンサー" selected="selected">ブレードダンサー</option>
										<option if={user.job=='アビスウォーカー'} value="アビスウォーカー" selected="selected">アビスウォーカー</option>
										<option if={user.job=='ファントムレンジャー'} value="ファントムレンジャー" selected="selected">ファントムレンジャー</option>
										<option if={user.job=='スペルハウラー'} value="スペルハウラー" selected="selected">スペルハウラー</option>
										<option if={user.job=='シリエンエルダー'} value="シリエンエルダー" selected="selected">シリエンエルダー</option>
										<option if={user.job!='シリエンナイト'} value="シリエンナイト">シリエンナイト</option>
										<option if={user.job!='ブレードダンサー'} value="ブレードダンサー">ブレードダンサー</option>
										<option if={user.job!='アビスウォーカー'} value="アビスウォーカー">アビスウォーカー</option>
										<option if={user.job!='ファントムレンジャー'} value="ファントムレンジャー">ファントムレンジャー</option>
										<option if={user.job!='スペルハウラー'} value="スペルハウラー">スペルハウラー</option>
										<option if={user.job!='シリエンエルダー'} value="シリエンエルダー">シリエンエルダー</option>
									</optgroup>
									<optgroup label="ドワーフ">
										<option if={user.job=='ガーディアン'} value="ガーディアン" selected="selected">ガーディアン</option>
										<option if={user.job=='スレイヤー'} value="スレイヤー" selected="selected">スレイヤー</option>
										<option if={user.job=='スカベンジャー'} value="スカベンジャー" selected="selected">スカベンジャー</option>
										<option if={user.job=='ウォーレンジャー'} value="ウォーレンジャー" selected="selected">ウォーレンジャー</option>
										<option if={user.job=='クォーラルウィザード'} value="クォーラルウィザード" selected="selected">クォーラルウィザード</option>
										<option if={user.job=='セイジ'} value="セイジ" selected="selected">セイジ</option>
										<option if={user.job!='ガーディアン'} value="ガーディアン">ガーディアン</option>
										<option if={user.job!='スレイヤー'} value="スレイヤー">スレイヤー</option>
										<option if={user.job!='スカベンジャー'} value="スカベンジャー">スカベンジャー</option>
										<option if={user.job!='ウォーレンジャー'} value="ウォーレンジャー">ウォーレンジャー</option>
										<option if={user.job!='クォーラルウィザード'} value="クォーラルウィザード">クォーラルウィザード</option>
										<option if={user.job!='セイジ'} value="セイジ">セイジ</option>
									</optgroup>
								</select>
							</div>
							<div class="form-group">
								<div class="btn-group">
									<input type="number" pattern="\d{4,8}" name="usercp" value="{user.cp}" class="form-control" placeholder="戦闘力"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<div class="form-group">
								<div class="btn-group">
									<input type="number" pattern="\d{2,3}" name="userlevel" value="{user.level}" class="form-control" placeholder="レベル"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<div class="form-group">
								<select class="form-control" name="usermeteo">
									<option>メテオ</option>
									<option if={user.meteo==10} selected="selected">10</option>
									<option if={user.meteo==9} selected="selected">9</option>
									<option if={user.meteo==8} selected="selected">8</option>
									<option if={user.meteo==7} selected="selected">7</option>
									<option if={user.meteo==6} selected="selected">6</option>
									<option if={user.meteo==5} selected="selected">5</option>
									<option if={user.meteo==4} selected="selected">4</option>
									<option if={user.meteo==3} selected="selected">3</option>
									<option if={user.meteo==2} selected="selected">2</option>
									<option if={user.meteo==1} selected="selected">1</option>
									<option if={user.meteo!=10}>10</option>
									<option if={user.meteo!=9}>9</option>
									<option if={user.meteo!=8}>8</option>
									<option if={user.meteo!=7}>7</option>
									<option if={user.meteo!=6}>6</option>
									<option if={user.meteo!=5}>5</option>
									<option if={user.meteo!=4}>4</option>
									<option if={user.meteo!=3}>3</option>
									<option if={user.meteo!=2}>2</option>
									<option if={user.meteo!=1}>1</option>
								</select>
							</div>
							<div class="form-group">
								<select class="form-control" name="useractivity">
									<option>状態</option>
									<option if={user.activity==1} value="1" selected="selected">アクティブ</option>
									<option if={user.activity==0} value="0" selected="selected">インアクティブ</option>
									<option if={user.activity==-1} value="-1" selected="selected">除名</option>
									<option if={user.activity!=1} value="1">アクティブ</option>
									<option if={user.activity!=0} value="0">インアクティブ</option>
									<option if={user.activity!=-1} value="-1">除名</option>
								</select>
							</div>
							<div class="form-group bg-info">
								<h5>入団日(選択して下さい)</h5>
								<div class='input-group date' id='joinddate'/>
							</div>
							<botton class="btn btn-success" onclick="onclickRegister(this, '{user.ID}')">登録</botton>
							<botton if={user.ID!=''} class="btn btn-danger" onclick="onclickUnregister(this, '{user.ID}')">削除</botton>
						</form>
					</div>
					var user = { ID: '', name: '', job: '', cp: '', level: '', meteo: 0, activity: 9, joind: '',};
					this.on('mount', function() {
						//$('#joinddate').datetimepicker({locale: 'ja', inline: true, sideBySide: true, format: "YYYY/MM/DD 00:00:00",});
						auth(false, function (clan) {
							if ('#modifyuser' == location.hash && 'undefined' != typeof getParams['userid'] && 0 < getParams['userid'].length) {
								// modifyモード
								getUser(getParams['userid'], function(user) {
									console.log(user);
									this.user = user;
									$('#joinddate').datetimepicker({locale: 'ja', inline: true, sideBySide: true, format: "YYYY/MM/DD 00:00:00", defaultDate: user.joind, });
									riot.update();
								});
							}
							else {
								// 初期化
								this.user = user;
								$('#joinddate').datetimepicker({locale: 'ja', inline: true, sideBySide: true, format: "YYYY/MM/DD 00:00:00"});
								riot.update();
							}
						});
					});
				</adduser>
			</script>

			<script type="riot/tag">
				<addschedule>
					<div style="padding: 10px;">
						<form id="addscheduleform">
							<div class="form-group">
								<div class="btn-group">
									<input type="text" name="schedulename" value="{schedule.name}" class="form-control" placeholder="予定内容"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<div class="form-group bg-info">
								<h5>予定日時(選択して下さい)</h5>
								<div class='input-group date' id='scheduledate'/>
							</div>
							<input type="hidden" name="scheduleincount" value="{schedule.incount}" id='scheduleincount'/>
							<botton class="btn btn-success" onclick="onclickRegisterSchedule(this, '{schedule.ID}')">登録</botton>
						</form>
					</div>
					var schedule = { ID: '', name: '', date: '',};
					this.on('mount', function() {
						auth(false, function (clan) {
							if ('#detailschedule' == location.hash && 'undefined' != typeof getParams['scheduleid'] && 0 < getParams['scheduleid'].length) {
								// modifyモード
								getSchedule(getParams['scheduleid'], function(schedule) {
									console.log(schedule);
									this.schedule = schedule;
									$('#scheduledate').datetimepicker({locale: 'ja', inline: true, sideBySide: true, defaultDate: schedule.date, });
									riot.update();
								});
							}
							else {
								// 初期化
								this.schedule = schedule;
								$('#scheduledate').datetimepicker({locale: 'ja', inline: true, sideBySide: true, });
								riot.update();
							}
						});
					});
				</addschedule>
			</script>

			<script type="riot/tag">
				<detailschedule>
					<div  class="row">
						<div class="col-xs-4">
							<div class="container-fluid">
								<div style="padding-left: 10px; padding-right: 10px;">
									<h3 style="margin-left: 10px;">参加登録</h3>
									<form id="entryscheduleform">
										<div class="form-group">
											<select class="form-control" name="scheduleuser">
												<option value="-1">参加キャラ</option>
												<option each="{user, index in selectusers}" value={index}>{user.name}</option>
											</select>
										</div>
										<div class="form-group">
											<div class="btn-group">
												<botton class="btn btn-success" onclick="{onEntryOK}">◯</botton>
												<botton class="btn btn-warning" onclick="{onEntryMaybe}">△</botton>
												<botton class="btn btn-danger" onclick="{onEntryNG}">✕</botton>
											</div>
										</div>
									</form>
								</div>
								<h3 style="margin-left: 10px;">予定詳細</h3>
								<addschedule/>
							</div>
						</div>
						<div class="col-xs-8">
							<div class="container-fluid">
								<h3>参加者一覧</h3>
								<users data='{scheduleusers}' mode='schedule'/>
							</div>
						</div>
					</div>
					var selectusers = [];
					var scheduleusers = [];
					var thisis;
					this.on('mount', function() {
						thisis = this;
						// 認証
						auth(false, function (clan) {
							getUsers(clan.ID, function(users) {
								thisis.selectusers = users;
								getScheduleUsers(getParams['scheduleid'], null, function(scheduleusers) {
									thisis.scheduleusers = scheduleusers;
									riot.update();
								});
							});
						});
					});
					onEntryOK = function () {
						var index = $('#entryscheduleform').find('select[name=scheduleuser] option:selected').val();
						if (0 > parseInt(index)) {
							alert('参加キャラを選択して下さい。');
							return;
						}
						var scheduleuser = thisis.selectusers[index];
						scheduleuser.entry = 1;
						registerScheduleuser(getParams['scheduleid'], scheduleuser, function (){
							getScheduleUsers(getParams['scheduleid'], true, function(entryOKUsers) {
								$('#addscheduleform').find('input[name=scheduleincount]').val(entryOKUsers.length).ready(function (){
									onclickRegisterSchedule(null, getParams['scheduleid']);
								});
							});
						});
					};
					onEntryMaybe = function () {
						var index = $('#entryscheduleform').find('select[name=scheduleuser] option:selected').val();
						if (0 > parseInt(index)) {
							alert('参加キャラを選択して下さい。');
							return;
						}
						var scheduleuser = thisis.selectusers[index];
						scheduleuser.entry = 0;
						registerScheduleuser(getParams['scheduleid'], scheduleuser, function (){
							getScheduleUsers(getParams['scheduleid'], true, function(entryOKUsers) {
								$('#addscheduleform').find('input[name=scheduleincount]').val(entryOKUsers.length).ready(function (){
									onclickRegisterSchedule(null, getParams['scheduleid']);
								});
							});
						});
					};
					onEntryNG = function () {
						var index = $('#entryscheduleform').find('select[name=scheduleuser] option:selected').val();
						if (0 > parseInt(index)) {
							alert('参加キャラを選択して下さい。');
							return;
						}
						var scheduleuser = thisis.selectusers[index];
						scheduleuser.entry = -1;
						registerScheduleuser(getParams['scheduleid'], scheduleuser, function (){
							getScheduleUsers(getParams['scheduleid'], true, function(entryOKUsers) {
								$('#addscheduleform').find('input[name=scheduleincount]').val(entryOKUsers.length).ready(function (){
									onclickRegisterSchedule(null, getParams['scheduleid']);
								});
							});
						});
					};
				</detailschedule>
			</script>

			<script type="riot/tag">
				<users>
					<div style="padding-right: 10px;">
						<table class="table table-bordered table-hover table-striped">
							<thead>
								<tr class="info">
									<th if={opts.mode=='schedule'}>参加</th>
									<th>キャラクター名</th>
									<th onclick="{sortCP}">戦闘力</th>
									<th onclick="{sortLevel}">レベル</th>
									<th>職種</th>
									<th>メテオ</th>
									<th if={opts.mode!='schedule'}>状態</th>
									<th if={opts.mode!='schedule'} onclick="{sortJoind}">入隊日</th>
								</tr>
							</thead>
							<tbody>
								<tr each="{user, index in opts.data}" onclick="onclickModify(this, '{user.ID}');">
									<td if={opts.mode=='schedule' && user.entry==1} class="success">◯</td>
									<td if={opts.mode=='schedule' && user.entry==0} class="warning">△</td>
									<td if={opts.mode=='schedule' && user.entry==-1} class="danger">✕</td>
									<td>{user.name}</td>
									<td>{user.cp}</td>
									<td>{user.level}</td>
									<td>{user.job}</td>
									<td if={user.meteo==10}>{user.meteo}</td>
									<td if={user.meteo!=10} class="warning">{user.meteo}</td>
									<td if={opts.mode!='schedule' && user.activity==1} class="success">アクティブ</td>
									<td if={opts.mode!='schedule' && user.activity==0} class="warning">インアクティブ</td>
									<td if={opts.mode!='schedule' && user.activity==-1} class="danger">除名</td>
									<td if={opts.mode!='schedule'}>{user.joind}</td>
								</tr>
							</tbody>
						</table>
					</div>
					var thisis;
					this.on('mount', function() {
						thisis = this;
						thisis.users = opts.data;
					});
					var cpdesc = true;
					var leveldesc = true;
					var joinddesc = true;
					sortCP = function () {
						if (cpdesc) {
							cpdesc = false;
							leveldesc = false;
							joinddesc = false;
							opts.data.sort(function(a, b){
								if( a.cp < b.cp ) return -1;
								if( a.cp > b.cp ) return 1;
								return 0;
							});
						}
						else {
							cpdesc = true;
							leveldesc = true;
							joinddesc = true;
							opts.data.sort(function(a, b){
								if( a.cp > b.cp ) return -1;
								if( a.cp < b.cp ) return 1;
								return 0;
							});
						}
					};
					sortLevel = function () {
						if (leveldesc) {
							cpdesc = false;
							leveldesc = false;
							joinddesc = false;
							opts.data.sort(function(a, b){
								if( a.level < b.level ) return -1;
								if( a.level > b.level ) return 1;
								return 0;
							});
						}
						else {
							cpdesc = true;
							leveldesc = true;
							joinddesc = true;
							opts.data.sort(function(a, b){
								if( a.level > b.level ) return -1;
								if( a.level < b.level ) return 1;
								return 0;
							});
						}
					};
					sortJoind = function () {
						if (joinddesc) {
							cpdesc = false;
							leveldesc = false;
							joinddesc = false;
							opts.data.sort(function(a, b){
								if ('' == a.joind || 'undefined' == typeof a.joind) return -1;
								if ('' == b.joind || 'undefined' == typeof b.joind) return 1;
								if( new Date(a.joind).getTime() < new Date(b.joind).getTime() ) return -1;
								if( new Date(a.joind).getTime() > new Date(b.joind).getTime() ) return 1;
								if( a.level > b.level ) return 1;
								return 0;
							});
						}
						else {
							cpdesc = true;
							leveldesc = true;
							joinddesc = true;
							opts.data.sort(function(a, b){
								if ('' == a.joind || 'undefined' == typeof a.joind) return 1;
								if ('' == b.joind || 'undefined' == typeof b.joind) return -1;
								if( new Date(a.joind).getTime() > new Date(b.joind).getTime() ) return -1;
								if( new Date(a.joind).getTime() < new Date(b.joind).getTime() ) return 1;
								return 0;
							});
						}
					};
				</users>
			</script>

		</section>

		<section id="scripts">
			<!-- bootstrap -->
			<script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
			<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
			<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment-with-locales.min.js"></script>
			<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
			<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script

			<!-- Riot -->
			<script src="//cdn.jsdelivr.net/npm/riot@3.9/riot+compiler.min.js"></script>
			<!-- Riot tag base rooting -->
			<script src="//cdn.jsdelivr.net/npm/riot-route@3.1.3/dist/route+tag.min.js"></script>

			<!-- Firebase -->
			<script src="//www.gstatic.com/firebasejs/5.2.0/firebase.js"></script>
			<script>
				// Initialize Firebase
				var config = {
					apiKey: "AIzaSyDYyTbnnltwtf4qPOjn7i1d3PRVAQBclIE",
					authDomain: "rinerebo-210503.firebaseapp.com",
					databaseURL: "https://rinerebo-210503.firebaseio.com",
					projectId: "rinerebo-210503",
					storageBucket: "rinerebo-210503.appspot.com",
					messagingSenderId: "599651332341",
					timestampsInSnapshots: true,
				};
				firebase.initializeApp(config);
			</script>

			<!-- this app -->
			<script>
				var getParams = {};
				var loadingCount = 0;
				var clan = null;
				var user = { ID: '', name: '', job: '', cp: '', level: '', meteo: 0, activity: 9, joind: '',};
				var schedule = { ID: '', name: '', date: '', incount: 0, };
				var getUrlVars = function(){
					var vars = {};
					var param = location.search.substring(1).split('&');
					for(var i = 0; i < param.length; i++) {
							var keySearch = param[i].search(/=/);
							var key = '';
							if(keySearch != -1) key = param[i].slice(0, keySearch);
							var val = param[i].slice(param[i].indexOf('=', 0) + 1);
							if(key != '') vars[key] = decodeURI(val);
					}
					return vars;
				};
				var loading = function (show) {
					if (show) {
						loadingCount++;
						$('#loader').fadeIn();
					}
					else {
						loadingCount--;
						if (1 > loadingCount) {
							$('#loader').fadeOut();
							loadingCount = 0;
						}
					}
				};
				var auth = function (clanID, callback) {
					loading(true);
					var loginRedirect = false;
					var key = null;
					if ('undefined' != typeof clanID && 0 < clanID.length) {
						key = clanID;
						loginRedirect = true;
					} else if ('undefined' != typeof getParams['clanid'] && 0 < getParams['clanid'].length) {
						key = getParams['clanid'];
						if ('' == location.hash || '#login' == location.hash) {
							loginRedirect = true;
						}
					}
					if (key == null) {
						// ログイン画面へ
						location.href = '#login';
						loading(false);
						return;
					}
					// firbase問い合わせ
					firebase.firestore().collection("clans").doc(key).get().then(function(snapshot){
  					if(snapshot.exists) {
							var data = snapshot.data();
							// 血盟名が取れていればOK
							if ('undefined' != typeof data.name && 0 < data.name.length) {
								clan = data;
								clan.ID = snapshot.id;
								if (loginRedirect) {
									getParams['clanid'] = key;
									location.href = '?clanid=' + key + '#dashboard';
								}
								if (callback) {
									callback(data);
								}
								loading(false);
								return;
							}
						}
						alert('該当する血盟が見つかりませんでした。');
						// ログイン出来ていないのでログイン画面へ戻す
						location.href = '#login';
					}).catch(function(error) {
						alert('認証エラーが発生した為、ログイン処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						location.href = '#login';
						loading(false);
					});
				};
				var registerClan = function (data, callback) {
					loading(true);
					firebase.firestore().collection("clans").add(data).then(function(snapshot) {
						if (callback) {
							callback(snapshot.id);
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('登録エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var registerSchedule = function (clanID, data, callback) {
					if (clanID == null || 'undefined' == typeof clanID || 1 > clanID.length) {
						return;
					}
					loading(true);
					data.clanid = clanID;
					if (data.ID != '') {
						scheduleID = data.ID;
						delete data.ID;
						firebase.firestore().collection("schedules").doc(scheduleID).set(data).then(function() {
							if (callback) {
								callback();
							}
							loading(false);
							return;
						}).catch(function(error) {
							alert('予定更新エラーが発生した為、処理を中断します。');
							console.error("Error writing document: ", error);
							// ログイン出来ていないのでログイン画面へ戻す
							loading(false);
						});
					}
					else {
						firebase.firestore().collection("schedules").add(data).then(function() {
							if (callback) {
								callback();
							}
							loading(false);
							return;
						}).catch(function(error) {
							alert('予定追加エラーが発生した為、処理を中断します。');
							console.error("Error writing document: ", error);
							// ログイン出来ていないのでログイン画面へ戻す
							loading(false);
						});
					}
				};
				var registerScheduleuser = function (scheduleID, data, callback) {
					if (scheduleID == null || 'undefined' == typeof scheduleID || 1 > scheduleID.length) {
						return;
					}
					loading(true);
					firebase.firestore().collection("schedules").doc(scheduleID).collection("users").doc(data.ID).set(data).then(function() {
						if (callback) {
							callback();
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('参加登録エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var registerUser = function (clanID, data, callback) {
					if (clanID == null || 'undefined' == typeof clanID || 1 > clanID.length) {
						return;
					}
					loading(true);
					data.clanid = clanID;
					if (data.ID != '') {
						userID = data.ID;
						delete data.ID;
						firebase.firestore().collection("users").doc(userID).set(data).then(function() {
							if (callback) {
								callback();
							}
							loading(false);
							return;
						}).catch(function(error) {
							alert('更新エラーが発生した為、処理を中断します。');
							console.error("Error writing document: ", error);
							// ログイン出来ていないのでログイン画面へ戻す
							loading(false);
						});
					}
					else {
						firebase.firestore().collection("users").add(data).then(function() {
							if (callback) {
								callback();
							}
							loading(false);
							return;
						}).catch(function(error) {
							alert('追加エラーが発生した為、処理を中断します。');
							console.error("Error writing document: ", error);
							// ログイン出来ていないのでログイン画面へ戻す
							loading(false);
						});
					}
				};
				var unregisterUser = function (userID, callback) {
					if (userID == null || 'undefined' == typeof userID || 1 > userID.length) {
						return;
					}
					loading(true);
					firebase.firestore().collection("users").doc(userID).delete().then(function() {
						if (callback) {
							callback();
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('更新エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var getSchedules = function (clanID, callback) {
					if (clanID == null || 'undefined' == typeof clanID || 1 > clanID.length) {
						return;
					}
					loading(true);
					firebase.firestore().collection("schedules").where("clanid", "==", clanID).orderBy("date", "asc").get().then(function(querySnapshot) {
						var datas = [];
						querySnapshot.forEach(function(snapshot) {
							if(snapshot.exists) {
								console.log(snapshot);
								var data = snapshot.data();
								data.ID = snapshot.id;
								if ('undefined' != typeof data.date) {
									data.date = data.date.toLocaleString();
								}
								datas.push(data);
							}
						});
						if ('undefined' != typeof datas) {
							if (callback) {
								callback(datas);
							}
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('予定一覧参照エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var getUsers = function (clanID, callback) {
					if (clanID == null || 'undefined' == typeof clanID || 1 > clanID.length) {
						return;
					}
					loading(true);
					firebase.firestore().collection("users").where("clanid", "==", clanID).orderBy("cp", "desc").get().then(function(querySnapshot) {
						var datas = [];
						querySnapshot.forEach(function(snapshot) {
							if(snapshot.exists) {
								console.log(snapshot);
								var data = snapshot.data();
								data.ID = snapshot.id;
								if ('undefined' != typeof data.joind) {
									data.joind = data.joind.toLocaleString();
									data.joind = data.joind.split(' ')[0];
								}
								datas.push(data);
							}
						});
						if ('undefined' != typeof datas) {
							if (callback) {
								callback(datas);
							}
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('一覧参照エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var getSchedule = function (scheduleID, callback) {
					if (scheduleID == null || 'undefined' == typeof scheduleID || 1 > scheduleID.length) {
						return;
					}
					loading(true);
					// firbase問い合わせ
					firebase.firestore().collection("schedules").doc(scheduleID).get().then(function(snapshot){
  					if(snapshot.exists) {
							var data = snapshot.data();
							data.ID = snapshot.id;
							if ('undefined' != typeof data.date) {
								data.date = data.date.toLocaleString();
							}
							if ('undefined' != typeof data.name && 0 < data.name.length) {
								if (callback) {
									callback(data);
								}
							}
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('予定詳細参照エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var getScheduleUsers = function (scheduleID, entryOK, callback) {
					if (scheduleID == null || 'undefined' == typeof scheduleID || 1 > scheduleID.length) {
						return;
					}
					loading(true);
					var collection = firebase.firestore().collection("schedules").doc(scheduleID).collection("users");
					if (entryOK) {
						collection = collection.where('entry', '==', 1);
					}
					collection.get().then(function(querySnapshot) {
						var datas = [];
						querySnapshot.forEach(function(snapshot) {
							if(snapshot.exists) {
								var data = snapshot.data();
								data.ID = snapshot.id;
								datas.push(data);
							}
						});
						if ('undefined' != typeof datas) {
							if (callback) {
								callback(datas);
							}
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('参照エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var getUser = function (userID, callback) {
					if (userID == null || 'undefined' == typeof userID || 1 > userID.length) {
						return;
					}
					loading(true);
					// firbase問い合わせ
					firebase.firestore().collection("users").doc(userID).get().then(function(snapshot){
  					if(snapshot.exists) {
							var data = snapshot.data();
							data.ID = snapshot.id;
							if ('undefined' != typeof data.joind) {
								data.joind = data.joind.toLocaleString();
							}
							if ('undefined' != typeof data.name && 0 < data.name.length) {
								if (callback) {
									callback(data);
								}
							}
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('詳細参照エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var clerinput = function (target) {
					$(target).parent().find('input').val('');
				};
				var onclickLogin = function (target) {
					var clanID = $('#loginform').find('input[name=clanID]').val();
					auth(clanID);
				};
				var onclickAddClan = function (target) {
					location.href='#addclan';
				};
				var onclickRegisterClan = function (target) {
					var clanname = $('#registerClanform').find('input[name=clan]').val();
					var clanurl = $('#registerClanform').find('input[name=url]').val();
					if (0 < clanname.length) {
						var data = {name: clanname, url: clanurl, };
						registerClan(data, function (newClanID){
							alert('登録しました。');
							getParams['clanid'] = newClanID;
							location.href = '?clanid=' + newClanID + '#dashboard';
						});
						return;
					}
					alert('入力が正しくない項目があった為、処理を中断します。');
				};
				var onclickRegisterSchedule = function (target, scheduleID) {
					var schedulename = $('#addscheduleform').find('input[name=schedulename]').val();
					var scheduledate = $('#addscheduleform').find('#scheduledate').data().date;
					var scheduleincount = $('#addscheduleform').find('input[name=scheduleincount]').val();
					if (1 > scheduleincount.length) {
						scheduleincount = '0';
					}
					if (0 < schedulename.length && 0 < scheduledate.length && 0 < scheduleincount.length) {
						var data = {ID: scheduleID, name: schedulename, date: new Date(scheduledate), incount: parseInt(scheduleincount), };
						registerSchedule(clan.ID, data, function (newScheduleID){
							if ('#detailschedule' == location.hash && 'undefined' != typeof getParams['scheduleid'] && 0 < getParams['scheduleid'].length) {
								if (target) {
									alert('更新しました。');
								}
								else {
									//location.href = '?clanid=' + clan.ID + '&scheduleid=' + getParams['scheduleid'] + '#detailschedule';
									location.reload();
								}
								return;
							}
							alert('登録しました。');
							location.href = '#dashboard';
						});
						return;
					}
					alert('入力が正しくない項目があった為、処理を中断します。');
				};
				var onclickRegister = function (target, userID) {
					var username = $('#registerform').find('input[name=username]').val();
					var userjob = $('#registerform').find('select[name=userjob] option:selected').val();
					var userlevel = $('#registerform').find('input[name=userlevel]').val();
					var usercp = $('#registerform').find('input[name=usercp]').val();
					var usermeteo = $('#registerform').find('select[name=usermeteo] option:selected').val();
					var useractivity = $('#registerform').find('select[name=useractivity] option:selected').val();
					var userjoind = $('#registerform').find('#joinddate').data().date;
					if ('職業' != userjob && 'メテオ' != usermeteo && '状態' != useractivity && 0 < username.length && 0 < userjob.length && 0 < userlevel.length && 0 < usercp.length && 0 < usermeteo.length && 0 < useractivity.length) {
						var data = {ID: userID, name: username, job: userjob, level: parseInt(userlevel), cp: parseInt(usercp), meteo: parseInt(usermeteo), activity: parseInt(useractivity)};
						if (0 < userjoind.length) {
							data.joind = new Date(userjoind);
						}
						registerUser(clan.ID, data, function (){
							alert('登録しました。');
							location.href='#dashboard';
						});
						return;
					}
					alert('入力が正しくない項目があった為、処理を中断します。');
				};
				var onclickUnregister = function (target, userID) {
					if (confirm('本当に削除してよろしいですか？')) {
						unregisterUser(userID, function (){
							alert('削除しました。');
							location.href='#dashboard';
						});
						return;
					}
				};
				var onclickSchedule = function (target, scheduleID) {
					getParams['clanid'] = clan.ID;
					getParams['scheduleid'] = scheduleID;
					location.href = '?clanid=' + clan.ID + '&scheduleid=' + scheduleID + '#detailschedule';
				};
				var onclickModify = function (target, userID) {
					if ('#detailschedule' == location.hash) {
						// 無視
						return;
					}
					getParams['clanid'] = clan.ID;
					getParams['userid'] = userID;
					location.href = '?clanid=' + clan.ID + '&userid=' + userID + '#modifyuser';
				};
				$(function() {
					loading(true);
					getParams = getUrlVars();
					$(window).load(function() {
						riot.mount('navigationbar');
						riot.mount('router');
						loading(false);
					});
				});
			</script>
		</section>
	</body>
</html>

<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="utf-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<meta name="description" content="Sample Riot Dapps"/>
		<meta name="robots" content="noindex"/>
		<title>リネレボツール</title>
		<!-- bootstrap -->
		<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"/>
		<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/css-spinning-spinners/1.1.1/load8.css"/>
		<link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
		<!-- this app -->
		<style>
			html, body {
				height: 100%;
			}
			navigationbar .container {
				width: 100%;
			}
			.orverlay {
				display: none;
				position: absolute;
				height: 100%;
				width: 100%;
				z-index: 9999;
				background-color: rgba(0, 0, 0, 0.4);
			}
			.btn-group {
				width: 100%;
			}
			.btn-group .form-control {
				padding-right: 20px;
			}
			.clearbtn {
				position: absolute;
				right: 5px;
				top: 0;
				bottom: 0;
				height: 14px;
				margin: auto;
				font-size: 14px;
				cursor: pointer;
				color: #ccc;
			}
			#loader {
				z-index: 99999;
			}
		</style>
	</head>

	<body>
		<div id="loader" class="orverlay loading"></div>
		<div id="popup" class="orverlay"></div>
		<app class="container">
			<navigationbar></navigationbar>
			<router class="row">
				<route path="/">
					<top/>
				</route>
				<route path="login">
					<login/>
				</route>
				<route path="dashboard">
					<dashboard/>
				</route>
				<route path="adduser">
					<adduser/>
				</route>
			</router>
		</app>

		<!-- Riot tags -->
		<section id="riot-tags">

			<script type="riot/tag">
				<navigationbar>
					<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
						<div class="container">
							<div class="navbar-header">
								<!-- sp用 -->
								<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
									<span class="sr-only">Toggle navigation</span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</button>
								<a class="navbar-brand" href="#">L2R Tool</a>
							</div>
							<div class="collapse navbar-collapse">
								<ul class="nav navbar-nav">
									<li><a href="#dashboard">血盟ページ</a></li>
									<li><a href="mailto:saimushi@gmail.com">お問い合わせ</a></li>
								</ul>
							</div>
						</div>
					</div>
				</navigationbar>
			</script>

			<script type="riot/tag">
				<top>
					<div style="padding: 10px;">
						<form>
							<div class="form-group">
								<div class="btn-group">
									<input type="text" name="clan" class="form-control" placeholder="血盟名"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<botton class="btn btn-success">登録</botton>
						</form>
					</div>
				</top>
			</script>

			<script type="riot/tag">
				<dashboard>
					<div  class="row">

						<div class="col-md-2">
							<div class="container-fluid">
								<h2 style="margin-top: 10px;">{clanname}</h2>
								<h4>血盟員数: {usercnt}</h4>
								<div  class="row">
									<div class="col-md-6" style="padding-top: 10px;">
										<a class="btn btn-success" href="#adduser">血盟員追加</a>
									</div>
									<div class="col-md-6" style="padding-top: 10px;">
										<botton class="btn btn-success" href="#addschedule">予定追加</botton>
									</div>
								</div>
							</div>
						</div>

						<div class="col-md-10">
							<div class="container-fluid" style="padding-top: 50px;">
								<table class="table table-bordered table-hover table-striped">
									<thead>
										<tr class="info">
											<th>キャラクター名</th>
											<th>職種</th>
											<th>戦闘力</th>
											<th>レベル</th>
											<th>メテオ</th>
											<th>状態</th>
											<th>入隊日</th>
										</tr>
									</thead>
									<tbody>
										<tr each="{user, index in list}">
											<td onclick="alert('{user.ID}');">{user.name}</td>
											<td>{user.job}</td>
											<td>{user.cp}</td>
											<td>{user.level}</td>
											<td>{user.meteo}</td>
											<td if={user.activity==1} class="success">アクティブ</td>
											<td if={user.activity==0} class="warning">インアクティブ</td>
											<td if={user.activity==-1} class="danger">除名</td>
											<td>{user.joind}</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>

					</div>
					var clanname = '';
					var usercnt = 0;
					var list = [];
					this.on('mount', function() {
						// 認証
						auth(false, function (clan) {
							if ('undefined' != typeof clan.name) {
								console.log(clan);
								this.clanname = clan.name;
								this.usercnt = clan.users.length;
								getUsers(clan.ID, function(users) {
									console.log(users);
									this.list = users;
									riot.update();
								});
							}
						});
					});
				</dashboard>
			</script>

			<script type="riot/tag">
				<login>
					<div style="padding: 10px;">
						<h2>血盟ログイン</h2>
						<form id="loginform">
							<div class="form-group">
								<div class="btn-group">
									<input type="text" name="clanID" class="form-control" placeholder="血盟ID"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<botton class="btn btn-success" onclick="onclickLogin(this)">ログイン</botton>
						</form>
					</div>
					this.on('mount', function() {
						auth();
					});
				</login>
			</script>

			<script type="riot/tag">
				<adduser>
					<div style="padding: 10px;">
						<h2>血盟員追加</h2>
						<form id="registerform">
							<div class="form-group">
								<div class="btn-group">
									<input type="text" name="username" class="form-control" placeholder="キャラクター名"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<div class="form-group">
								<select class="form-control" name="userjob">
									<option disabled="disabled" selected="selected">職業</option>
									<optgroup label="ヒューマン">
										<option value="パラディン">パラディン</option>
										<option value="ウォーロード">ウォーロード</option>
										<option value="トレジャーハンター">トレジャーハンター</option>
										<option value="ホークアイ">ホークアイ</option>
										<option value="ソーサラー">ソーサラー</option>
										<option value="ビショップ">ビショップ</option>
									</optgroup>
									<optgroup label="エルフ">
										<option value="テンプルナイト">テンプルナイト	</option>
										<option value="ソードシンガー">ソードシンガー	</option>
										<option value="プレインズウォーカー">プレインズウォーカー</option>
										<option value="シルバーレンジャー">シルバーレンジャー</option>
										<option value="スペルシンガー">スペルシンガー</option>
										<option value="エルダー">エルダー</option>
									</optgroup>
									<optgroup label="ダークエルフ">
										<option value="シリエンナイト">シリエンナイト</option>
										<option value="ブレードダンサー">ブレードダンサー</option>
										<option value="アビスウォーカー">アビスウォーカー</option>
										<option value="ファントムレンジャー">ファントムレンジャー</option>
										<option value="スペルハウラー">スペルハウラー</option>
										<option value="シリエンエルダー">シリエンエルダー</option>
									</optgroup>
									<optgroup label="ドワーフ">
										<option value="ガーディアン">ガーディアン</option>
										<option value="スレイヤー">スレイヤー</option>
										<option value="スカベンジャー">スカベンジャー</option>
										<option value="ウォーレンジャー">ウォーレンジャー</option>
										<option value="クォーラルウィザード">クォーラルウィザード</option>
										<option value="セイジ">セイジ</option>
									</optgroup>
								</select>
							</div>
							<div class="form-group">
								<div class="btn-group">
									<input type="number" pattern="\d{4,8}" name="usercp" class="form-control" placeholder="戦闘力"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<div class="form-group">
								<div class="btn-group">
									<input type="number" pattern="\d{2,3}" name="userlevel" class="form-control" placeholder="レベル"/>
									<span class="clearbtn glyphicon glyphicon-remove-circle" onclick="clerinput(this)"></span>
								</div>
							</div>
							<div class="form-group">
								<select class="form-control" name="usermeteo">
									<option disabled="disabled" selected="selected">メテオ</option>
									<option>10</option>
									<option>9</option>
									<option>8</option>
									<option>7</option>
									<option>6</option>
									<option>5</option>
									<option>4</option>
									<option>3</option>
									<option>2</option>
									<option>1</option>
								</select>
							</div>
							<div class="form-group">
								<select class="form-control" name="useractivity">
									<option disabled="disabled" selected="selected">状態</option>
									<option value="1">アクティブ</option>
									<option value="0">インアクティブ</option>
									<option value="-1">除名</option>
								</select>
							</div>
							<botton class="btn btn-success" onclick="onclickRegister(this)">登録</botton>
						</form>
					</div>
					this.on('mount', function() {
						auth();
					});
				</adduser>
			</script>

		</section>

		<section id="scripts">
			<!-- bootstrap -->
			<script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
			<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
			<!-- Riot -->
			<script src="//cdn.jsdelivr.net/npm/riot@3.9/riot+compiler.min.js"></script>
			<!-- Riot tag base rooting -->
			<script src="//cdn.jsdelivr.net/npm/riot-route@3.1.3/dist/route+tag.min.js"></script>

			<!-- Firebase -->
			<script src="//www.gstatic.com/firebasejs/5.2.0/firebase.js"></script>
			<script>
				// Initialize Firebase
				var config = {
					apiKey: "AIzaSyDYyTbnnltwtf4qPOjn7i1d3PRVAQBclIE",
					authDomain: "rinerebo-210503.firebaseapp.com",
					databaseURL: "https://rinerebo-210503.firebaseio.com",
					projectId: "rinerebo-210503",
					storageBucket: "rinerebo-210503.appspot.com",
					messagingSenderId: "599651332341",
					timestampsInSnapshots: true,
				};
				firebase.initializeApp(config);
			</script>

			<!-- this app -->
			<script>
				var getParams = {};
				var loadingCount = 0;
				var clan = null;
				var getUrlVars = function(){
					var vars = {};
					var param = location.search.substring(1).split('&');
					for(var i = 0; i < param.length; i++) {
							var keySearch = param[i].search(/=/);
							var key = '';
							if(keySearch != -1) key = param[i].slice(0, keySearch);
							var val = param[i].slice(param[i].indexOf('=', 0) + 1);
							if(key != '') vars[key] = decodeURI(val);
					}
					return vars;
				};
				var loading = function (show) {
					if (show) {
						loadingCount++;
						$('#loader').fadeIn();
					}
					else {
						loadingCount--;
						if (1 > loadingCount) {
							$('#loader').fadeOut();
							loadingCount = 0;
						}
					}
				};
				var auth = function (clanID, callback) {
					loading(true);
					var loginRedirect = false;
					var key = null;
					if ('undefined' != typeof clanID && 0 < clanID.length) {
						key = clanID;
						loginRedirect = true;
					} else if ('undefined' != typeof getParams['clanid'] && 0 < getParams['clanid'].length) {
						key = getParams['clanid'];
					}
					if (key == null) {
						// ログイン画面へ
						location.href = '#login';
						loading(false);
						return;
					}
					// firbase問い合わせ
					firebase.firestore().collection("clans").doc(key).get().then(function(snapshot){
  					if(snapshot.exists) {
							var data = snapshot.data();
							// 血盟名が取れていればOK
							if ('undefined' != typeof data.name && 0 < data.name.length) {
								clan = data;
								clan.ID = snapshot.id;
								if (loginRedirect) {
									location.href = '?clanid='+key+'#dashboard';
								}
								if (callback) {
									callback(data);
								}
								loading(false);
								return;
							}
						}
						alert('該当する血盟が見つかりませんでした。');
						// ログイン出来ていないのでログイン画面へ戻す
						location.href = '#login';
					}).catch(function(error) {
						alert('認証エラーが発生した為、ログイン処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						location.href = '#login';
						loading(false);
					});
				};
				var registerUser = function (clanID, data, callback) {
					if (clanID == null || 'undefined' == typeof clanID || 1 > clanID.length) {
						return;
					}
					loading(true);
					data.clanid = clanID;
					console.log(data);
					firebase.firestore().collection("users").add(data).then(function() {
						if (callback) {
							callback();
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('登録エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var getUsers = function (clanID, callback) {
					if (clanID == null || 'undefined' == typeof clanID || 1 > clanID.length) {
						return;
					}
					loading(true);
					// firbase問い合わせ
					firebase.firestore().collection("users").where("clanid", "==", clanID).get().then(function(querySnapshot) {
						var datas = [];
						querySnapshot.forEach(function(snapshot) {
							if(snapshot.exists) {
								console.log(snapshot);
								var data = snapshot.data();
								data.ID = snapshot.id;
								if ('undefined' != typeof data.joind) {
									data.joind = data.joind.toLocaleString();
								}
								datas.push(data);
							}
						});
						console.log(datas);
						if ('undefined' != typeof datas[0] && 0 < datas.length) {
							if (callback) {
								callback(datas);
							}
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('一覧参照エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var getUser = function (userID, callback) {
					if (clanID == null || 'undefined' == typeof clanID || 1 > clanID.length) {
						return;
					}
					loading(true);
					// firbase問い合わせ
					firebase.firestore().collection("users").doc(userID).get().then(function(snapshot){
  					if(snapshot.exists) {
							var data = snapshot.data();
							if ('undefined' != typeof data.name && 0 < data.name.length) {
								if (callback) {
									callback(data);
								}
							}
						}
						loading(false);
						return;
					}).catch(function(error) {
						alert('詳細参照エラーが発生した為、処理を中断します。');
						console.error("Error writing document: ", error);
						// ログイン出来ていないのでログイン画面へ戻す
						loading(false);
					});
				};
				var clerinput = function (target) {
					$(target).parent().find('input').val('');
				};
				var onclickLogin = function (target) {
					var clanID = $('#loginform').find('input[name=clanID]').val();
					auth(clanID);
				};
				var onclickRegister = function (target) {
					var username = $('#registerform').find('input[name=username]').val();
					var userjob = $('#registerform').find('select[name=userjob] option:selected').val();
					var userlevel = $('#registerform').find('input[name=userlevel]').val();
					var usercp = $('#registerform').find('input[name=usercp]').val();
					var usermeteo = $('#registerform').find('select[name=usermeteo] option:selected').val();
					var useractivity = $('#registerform').find('select[name=useractivity] option:selected').val();
					if ('職業' != userjob && 'メテオ' != usermeteo && '状態' != useractivity && 0 < username.length && 0 < userjob.length && 0 < userlevel.length && 0 < usercp.length && 0 < usermeteo.length && 0 < useractivity.length) {
						registerUser(clan.ID, {name: username, level: parseInt(userlevel), cp: parseInt(usercp), meteo: parseInt(usermeteo), activity: parseInt(useractivity)}, function (){
							alert('登録しました。');
							location.href='#dashboard';
						});
						return;
					}
					alert('入力が正しくない項目があった為、処理を中断します。');
				};
				$(function() {
					loading(true);
					getParams = getUrlVars();
					$(window).load(function() {
						riot.mount('navigationbar');
						riot.mount('router');
						loading(false);
					});
				});
			</script>
		</section>
	</body>
</html>
